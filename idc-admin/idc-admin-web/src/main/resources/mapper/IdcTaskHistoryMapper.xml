<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.iwellmass.idc.mapper.IdcTaskHistoryMapper" >
    <resultMap id="BaseResultMap" type="com.iwellmass.idc.model.JobInstance" >
        <id column="EXECUTE_ID" property="id" jdbcType="BIGINT" />
        <result column="TASK_ID" property="jobId" jdbcType="INTEGER" />
        <result column="SHOULD_FIRE_TIME" property="loadDate" jdbcType="BIGINT" typeHandler="com.iwellmass.dispatcher.admin.MillsHandler"/>
        <result column="ACTUAL_FIRE_TIME" property="executeTime" jdbcType="BIGINT" typeHandler="com.iwellmass.dispatcher.admin.MillsHandler" />
        <result column="FIRE_TIME" property="startTime" jdbcType="TIMESTAMP" />
        <result column="COMPLETE_TIME" property="endTime" jdbcType="TIMESTAMP" />
        <result column="TASK_NAME" property="taskName" jdbcType="VARCHAR" />
        <result column="WORKFLOW_ID" property="taskType" jdbcType="VARCHAR" typeHandler="com.iwellmass.dispatcher.admin.TaskTypeByWorkflowIdHandler"/>
        <result column="CLASS_NAME" property="contentType" jdbcType="VARCHAR" typeHandler="com.iwellmass.dispatcher.admin.ContentTypeHandler"/>
        <result column="OWNER" property="assignee" jdbcType="VARCHAR" />
        <result column="EXECUTE_RESULT" property="status" jdbcType="VARCHAR" />
        <result column="TRIGGER_TYPE" property="type" jdbcType="INTEGER" typeHandler="com.iwellmass.dispatcher.admin.JobInstanceTypeHandler"/>
    </resultMap>
    
    <sql id="Base_Column_List" >
      EXECUTE_ID,TASK_ID,SHOULD_FIRE_TIME,FIRE_TIME,COMPLETE_TIME, TASK_NAME,CLASS_NAME,OWNER,TRIGGER_TYPE,WORKFLOW_ID
    </sql>

    <select id="findAllTaskInstance" resultMap="BaseResultMap">
        SELECT
        TH.EXECUTE_ID,TH.TASK_ID,TH.SHOULD_FIRE_TIME,TH.FIRE_TIME,TH.COMPLETE_TIME,T.TASK_NAME,T.CLASS_NAME,T.OWNER,TH.TRIGGER_TYPE,TH.WORKFLOW_ID
        FROM DDC_TASK_EXECUTE_HISTORY AS TH JOIN DDC_TASK AS T ON TH.TASK_ID=T.TASK_ID
        ORDER BY EXECUTE_ID DESC
    </select>

    <select id="findTaskInstanceByCondition" resultMap="BaseResultMap">
        SELECT
        TH.EXECUTE_ID,TH.TASK_ID,TH.SHOULD_FIRE_TIME,TH.ACTUAL_FIRE_TIME,TH.FIRE_TIME,TH.EXECUTE_RESULT,TH.COMPLETE_TIME,T.TASK_NAME,T.CLASS_NAME,T.OWNER,TH.TRIGGER_TYPE
        ,TH.WORKFLOW_ID
        FROM DDC_TASK_EXECUTE_HISTORY AS TH JOIN DDC_TASK AS T ON TH.TASK_ID=T.TASK_ID
        <where>
            <if test="job.taskName !=null and job.taskName != '' ">
                AND T.TASK_NAME LIKE CONCAT(CONCAT('%',#{job.taskName,jdbcType=VARCHAR},'%'))
            </if>
            <if test="job.contentType !=null">
                AND T.CLASS_NAME = #{job.contentType,jdbcType=VARCHAR,typeHandler=com.iwellmass.dispatcher.admin.ContentTypeHandler}
            </if>
            <if test="job.assignee !=null and job.assignee != ''">
                AND T.OWNER= #{job.assignee,jdbcType=VARCHAR}
            </if>
            <if test="job.loadDateFrom !=null">
                AND TH.SHOULD_FIRE_TIME &gt;= #{job.loadDateFrom,jdbcType=BIGINT,typeHandler=com.iwellmass.dispatcher.admin.MillsHandler}
            </if>
            <if test="job.loadDateTo !=null">
                AND TH.SHOULD_FIRE_TIME &lt;= #{job.loadDateTo,jdbcType=BIGINT,typeHandler=com.iwellmass.dispatcher.admin.MillsHandler}
            </if>
            <if test="job.executeTimeFrom !=null">
                AND TH.ACTUAL_FIRE_TIME &gt;= #{job.executeTimeFrom,jdbcType=BIGINT,typeHandler=com.iwellmass.dispatcher.admin.MillsHandler}
            </if>
            <if test="job.executeTimeTo !=null">
                AND TH.ACTUAL_FIRE_TIME &lt;= #{job.executeTimeTo,jdbcType=BIGINT,typeHandler=com.iwellmass.dispatcher.admin.MillsHandler}
            </if>
            <if test="job.instanceType !=null">
                AND TH.TRIGGER_TYPE= #{job.instanceType,jdbcType=INTEGER,typeHandler=com.iwellmass.dispatcher.admin.JobInstanceTypeHandler}
            </if>
        </where>
        ORDER BY EXECUTE_ID DESC
        LIMIT #{pager.page},#{pager.limit}
    </select>
    <select id="findAllTaskInstanceByCondition" resultMap="BaseResultMap">
        SELECT
        TH.EXECUTE_ID,TH.TASK_ID,TH.WORKFLOW_ID,TH.SHOULD_FIRE_TIME,TH.ACTUAL_FIRE_TIME,TH.FIRE_TIME,TH.COMPLETE_TIME,TH.EXECUTE_RESULT,TH.EXECUTE_RESULT,T.TASK_NAME,T.CLASS_NAME,T.OWNER,TH.TRIGGER_TYPE
        FROM DDC_TASK_EXECUTE_HISTORY AS TH JOIN DDC_TASK AS T ON TH.TASK_ID=T.TASK_ID
        <where>
            <if test="taskName !=null and taskName != '' ">
                AND T.TASK_NAME LIKE CONCAT(CONCAT('%',#{taskName,jdbcType=VARCHAR},'%'))
            </if>
            <if test="contentType !=null">
                AND T.CLASS_NAME = #{contentType,jdbcType=VARCHAR,typeHandler=com.iwellmass.dispatcher.admin.ContentTypeHandler}
            </if>
            <if test="assignee !=null and assignee != ''">
                AND T.OWNER= #{assignee,jdbcType=VARCHAR}
            </if>
       		<if test="loadDateFrom !=null">
                AND TH.SHOULD_FIRE_TIME &gt;= #{loadDateFrom,jdbcType=BIGINT,typeHandler=com.iwellmass.dispatcher.admin.MillsHandler}
            </if>
            <if test="loadDateTo !=null">
                AND TH.SHOULD_FIRE_TIME &lt;= #{loadDateTo,jdbcType=BIGINT,typeHandler=com.iwellmass.dispatcher.admin.MillsHandler}
            </if>
            <if test="executeTimeFrom !=null">
                AND TH.ACTUAL_FIRE_TIME &gt;= #{executeTimeFrom,jdbcType=BIGINT,typeHandler=com.iwellmass.dispatcher.admin.MillsHandler}
            </if>
            <if test="executeTimeTo !=null">
                AND TH.ACTUAL_FIRE_TIME &lt;= #{executeTimeTo,jdbcType=BIGINT,typeHandler=com.iwellmass.dispatcher.admin.MillsHandler}
            </if>
            <if test="instanceType !=null">
                AND TH.TRIGGER_TYPE= #{instanceType,jdbcType=INTEGER,typeHandler=com.iwellmass.dispatcher.admin.JobInstanceTypeHandler}
            </if>
        </where>
       ORDER BY EXECUTE_ID DESC
    </select>
</mapper>